sudo: required
services:
- docker
- mongodb
language: bash
branches:
  only:
  - master
env:
- NODE_ENV=testing
before_install:
  - wget http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.2.10.tgz
  - tar xfz mongodb-linux-x86_64-3.2.10.tgz
  - export PATH=`pwd`/mongodb-linux-x86_64-3.2.10/bin:$PATH
  - mkdir -p data/db
  - mongod --dbpath=data/db &
  - sleep 3
install:
- sudo apt update -y
- sudo apt install --only-upgrade docker-ce -y
before_script:
  - sleep 15
  - mongo test db.createCollection("IoT")
script:
- |
  echo "Updating Docker to have docker manifest command"
  curl https://get.docker.com | sh
  echo "Enabling docker client experimental features"
  mkdir -p ~/.docker
  echo '{ "experimental": "enabled" }' > ~/.docker/config.json
  docker version
# prepare qemu
- docker run --rm --privileged multiarch/qemu-user-static:register --reset
# build image
- docker build -t haegi/silex .
# test image
- docker run -e NODE_ENV="testing" -p 8080:8080 haegi/silex
# push image
- >
  if [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
    docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
    TAG=0.1
    docker tag haegi/silex haegi/silex:arm-$TAG
    docker push haegi/silex:arm-$TAG
    docker manifest create haegi/silex:$TAG haegi/silex:arm-$TAG
    docker manifest annotate haegi/silex:$TAG haegi/silex:arm-$TAG --os linux --arch arm --variant v6
    docker manifest push haegi/silex:$TAG
    docker manifest create haegi/silex haegi/silex:arm-$TAG
    docker manifest annotate haegi/silex haegi/silex:arm-$TAG --os linux --arch arm --variant v6
    docker manifest push haegi/silex
  fi